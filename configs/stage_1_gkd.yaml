extends: base.yaml

# Stage 1: Full training on Aligner only (freeze LLM+ViT) - WITH GKD TRAINER

rlhf:
  rlhf_type: gkd
  teacher_model: model_cache/models/Qwen/Qwen3-VL-8B-Instruct
  beta: 0
  sft_alpha: 1
  seq_kd: false
  lmbda: 0.0

model:
  model: model_cache/models/Qwen/Qwen3-VL-8B-Instruct

tuner:
  train_type: full
  freeze_llm: true
  freeze_vit: true
  freeze_aligner: false

training:
  output_dir: ./output/11-05/stage_1-gkd
  run_name: gkd-eff_batch_32-epoch_6-less_weights
  per_device_train_batch_size: 1

  eval_strategy: steps
  save_strategy: best
  eval_steps: 20
  save_steps: 60
  save_total_limit: 2
  save_delay_steps: 200

  learning_rate: 1.0e-4
  vit_lr: 2.0e-5
  aligner_lr: 1.0e-4
  num_train_epochs: 6

  gradient_accumulation_steps: 4

  # Verbose logging
  logging_dir: ./tb/11-05/stage_1-gkd

data:
  dataset_num_proc: 8
  dataloader_num_workers: 8

custom:
  visual_kd:
    enabled: true
    weight: 0.004  # Heavier anchor on vision/aligner (0.1-0.2 typical). Lower if visuals overfit.
    targets: [merger]
    distance: mse
  dump_conversation_text: false
  trainer_variant: gkd_monitor