extends: ./sft_base.yaml

global_max_length: 12000

model:
  model: output/12-9/res_1024_fusion_merged/epoch50-updated_aug-checkpoint-4650
  # model: output/12-18/summary_merged/epoch_4-bbu_rru_summary

tuner:
  # Freeze vision/aligner; LoRA only on last-2 LLM blocks (lm_head fixed)
  freeze_llm: false   # Enable LoRA adapters on selected LLM layers
  freeze_vit: true    # Freeze vision encoder
  freeze_aligner: false  # Freeze MLP aligner
  # LoRA targets: LLM layers 34-35 (q/k/v/o + MLP) excluding lm_head
  target_regex: null
  modules_to_save: []  # Keep lm_head fixed (no tuning/saving)
  lora_rank: 16
  lora_alpha: 32

training:
  per_device_train_batch_size: 2
  per_device_eval_batch_size: 2
  effective_batch_size: 32
  num_train_epochs: 4
  output_dir: ./output/12-21/summary
  logging_dir: ./tb/12-21/summary
  run_name: epoch_4-bbu_rru-more_irrelevant-ocr
  learning_rate: 1.0e-4
  vit_lr: 1.0e-7
  aligner_lr: 1.0e-6
  save_delay_steps: 300
  
custom:
  # train_jsonl: data/bbu_full_768_poly-need_review/train.jsonl
  # val_jsonl: data/bbu_full_768_poly-need_review/val.jsonl
  fusion_config: configs/fusion/summary_lang_chat_0p2.yaml
  emit_norm: norm1000
  # Default to summary; individual fusion datasets can override with mode
  use_summary: true
  # Collapse identifiable 标签/* entries into 标签/可以识别 while keeping 无法识别 separate
  summary_label_grouping: false
  dump_conversation_text: false
  # Geometry-safe global augmentation (count/group stable; no crop/patch ops)
  augmentation:
    enabled: true
    bypass_prob: 0.1
    ops:
      - name: hflip
        params: { prob: 0.5 }
      - name: vflip
        params: { prob: 0.1 }
      - name: rotate
        params: { max_deg: 15.0, prob: 0.4 }
      - name: scale
        params: { lo: 0.9, hi: 1.1, prob: 0.3 }
      - name: color_jitter
        params: { brightness: [0.8, 1.2], contrast: [0.8, 1.2], saturation: [0.8, 1.2], prob: 0.5 }
      - name: gamma
        params: { gamma: [0.8, 1.2], prob: 0.3 }
      - name: hsv
        params: { hue_delta_deg: [-10, 10], sat: [0.9, 1.1], val: [0.9, 1.1], prob: 0.3 }
      - name: auto_contrast
        params: { cutoff: 0, prob: 0.2 }
      - name: sharpness
        params: { factor: [0.8, 1.3], prob: 0.2 }
      - name: expand_to_fit_affine
        params: { multiple: 32, max_pixels: 921600 }
  augmentation_curriculum: null
