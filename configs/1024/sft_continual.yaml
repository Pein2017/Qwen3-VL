extends: ./sft_base.yaml

# Continual learning run:
# - Initialize from a fused 1024 checkpoint
# - Train on the same fusion mix (RRU expanded in-place)
# - Use reduced LRs + a ramp-up augmentation curriculum

model:
  # Note: checkpoint is loaded via `model.model` (not CLI resume_from_checkpoint).
  model: output/12-9/res_1024_fusion_merged/epoch50-updated_aug-checkpoint-4650

training:
  output_dir: ./output/12-16/1024_fusion_continual
  logging_dir: ./tb/12-16/1024_fusion_continual
  run_name: epoch_12-continual_from_epoch50-expanded_rru-lrs_5e-5_2.5e-5_1.5e-4-aug_curriculum
  # Expanded target pools increase steps/epoch; keep the continual run shorter than the original 30-epoch recipe.
  num_train_epochs: 12

  # Reduced learning rates for continual learning (~0.5x original).
  learning_rate: 5.0e-5
  vit_lr: 2.5e-5
  aligner_lr: 1.5e-4

custom:
  # Keep the same fusion mix (RRU expanded at data/rru_full_1024_poly/train.jsonl).
  fusion_config: configs/fusion/bbu_rru_lvis_coig_1024.yaml

  augmentation:
    enabled: true

    # Start with lighter augmentation, then ramp to the original "full strength".
    bypass_prob: 0.60
    ops:
      - name: hflip
        params: { prob: 0.08 }
      - name: vflip
        params: { prob: 0.02 }
      - name: rotate
        params: { max_deg: 6.0, prob: 0.10 }
      - name: expand_to_fit_affine
        params: { multiple: 32 }
      - name: random_crop
        params:
          scale: [0.94, 1.00]
          aspect_ratio: [0.96, 1.04]
          min_coverage: 0.45
          completeness_threshold: 0.95
          min_objects: 4
          skip_if_line: true
          prob: 0.05
      - name: small_object_zoom_paste
        params:
          prob: 0.06
          max_targets: 1
          max_attempts: 16
          scale: [1.20, 1.50]
          max_size: 96
          max_line_length: 128
          overlap_threshold: 0.1
          context: 4
          line_buffer: 4
          class_whitelist: ["螺丝、光纤插头", "光纤", "标签", "电线"]
      - name: resize_by_scale
        params: { lo: 0.98, hi: 1.02, align_multiple: 32, prob: 0.15 }
      - name: color_jitter
        params: { brightness: [0.97, 1.03], contrast: [0.97, 1.03], saturation: [0.97, 1.03], prob: 0.05 }
      - name: gamma
        params: { gamma: [0.97, 1.03], prob: 0.02 }
      - name: hsv
        params: { hue_delta_deg: [-2, 2], sat: [0.98, 1.02], val: [0.98, 1.02], prob: 0.02 }
      - name: clahe
        params: { clip_limit: 1.10, tile_grid_size: [8, 8], prob: 0.01 }
      - name: auto_contrast
        params: { cutoff: 0, prob: 0.01 }
      - name: sharpness
        params: { factor: [0.98, 1.02], prob: 0.02 }

    # Progress-based curriculum (until_percent is in 0-100, strictly increasing).
    # Values interpolate linearly between phase boundaries.
    curriculum:
      phases:
        - until_percent: 5
          bypass_prob: 0.60
          ops: {}

        - until_percent: 25
          bypass_prob: 0.35
          ops:
            hflip: { prob: 0.12 }
            vflip: { prob: 0.04 }
            rotate: { prob: 0.18, max_deg: 10.0 }
            random_crop:
              prob: 0.10
              scale: [0.90, 1.00]
              aspect_ratio: [0.94, 1.06]
              min_coverage: 0.40
            small_object_zoom_paste:
              prob: 0.10
              max_targets: 1
              max_attempts: 18
              scale: [1.35, 1.75]
            resize_by_scale: { prob: 0.26, lo: 0.95, hi: 1.06 }
            color_jitter:
              prob: 0.10
              brightness: [0.95, 1.05]
              contrast: [0.95, 1.05]
              saturation: [0.95, 1.05]
            gamma: { prob: 0.04, gamma: [0.95, 1.05] }
            hsv: { prob: 0.04, hue_delta_deg: [-3, 3], sat: [0.97, 1.03], val: [0.97, 1.03] }
            clahe: { prob: 0.02, clip_limit: 1.15 }
            auto_contrast: { prob: 0.02 }
            sharpness: { prob: 0.03, factor: [0.97, 1.03] }

        - until_percent: 50
          bypass_prob: 0.20
          ops:
            hflip: { prob: 0.16 }
            vflip: { prob: 0.05 }
            rotate: { prob: 0.22, max_deg: 14.0 }
            random_crop:
              prob: 0.14
              scale: [0.86, 0.99]
              aspect_ratio: [0.92, 1.08]
              min_coverage: 0.38
            small_object_zoom_paste:
              prob: 0.14
              max_targets: 1
              max_attempts: 20
              scale: [1.40, 1.90]
            resize_by_scale: { prob: 0.34, lo: 0.93, hi: 1.08 }
            color_jitter:
              prob: 0.14
              brightness: [0.93, 1.07]
              contrast: [0.93, 1.07]
              saturation: [0.93, 1.07]
            gamma: { prob: 0.06, gamma: [0.93, 1.07] }
            hsv: { prob: 0.06, hue_delta_deg: [-4, 4], sat: [0.96, 1.04], val: [0.96, 1.04] }
            clahe: { prob: 0.03, clip_limit: 1.20 }
            auto_contrast: { prob: 0.03 }
            sharpness: { prob: 0.04, factor: [0.96, 1.05] }

        - until_percent: 75
          bypass_prob: 0.10
          ops:
            hflip: { prob: 0.20 }
            vflip: { prob: 0.055 }
            rotate: { prob: 0.26, max_deg: 16.0 }
            random_crop:
              prob: 0.16
              scale: [0.84, 0.98]
              aspect_ratio: [0.91, 1.09]
              min_coverage: 0.36
            small_object_zoom_paste:
              prob: 0.16
              max_targets: 2
              max_attempts: 22
              scale: [1.45, 2.00]
            resize_by_scale: { prob: 0.38, lo: 0.92, hi: 1.10 }
            color_jitter:
              prob: 0.16
              brightness: [0.92, 1.08]
              contrast: [0.92, 1.08]
              saturation: [0.92, 1.08]
            gamma: { prob: 0.07, gamma: [0.91, 1.09] }
            hsv: { prob: 0.07, hue_delta_deg: [-5, 5], sat: [0.95, 1.05], val: [0.95, 1.05] }
            clahe: { prob: 0.035, clip_limit: 1.20 }
            auto_contrast: { prob: 0.035 }
            sharpness: { prob: 0.045, factor: [0.955, 1.07] }

        - until_percent: 100
          # Match the original 1024 steady augmentation policy.
          bypass_prob: 0.05
          ops:
            hflip: { prob: 0.22 }
            vflip: { prob: 0.06 }
            rotate: { prob: 0.30, max_deg: 18.0 }
            random_crop:
              prob: 0.18
              scale: [0.82, 0.98]
              aspect_ratio: [0.90, 1.10]
              min_coverage: 0.35
              completeness_threshold: 0.95
              min_objects: 4
            small_object_zoom_paste:
              prob: 0.18
              max_targets: 2
              max_attempts: 24
              scale: [1.50, 2.10]
              max_size: 96
              max_line_length: 128
              overlap_threshold: 0.1
              context: 4
              line_buffer: 4
            resize_by_scale: { prob: 0.42, lo: 0.90, hi: 1.12 }
            color_jitter:
              prob: 0.18
              brightness: [0.90, 1.10]
              contrast: [0.90, 1.10]
              saturation: [0.90, 1.10]
            gamma: { prob: 0.08, gamma: [0.90, 1.10] }
            hsv: { prob: 0.08, hue_delta_deg: [-5, 5], sat: [0.95, 1.05], val: [0.95, 1.05] }
            clahe: { prob: 0.04, clip_limit: 1.2 }
            auto_contrast: { prob: 0.04, cutoff: 0 }
            sharpness: { prob: 0.05, factor: [0.95, 1.08] }

