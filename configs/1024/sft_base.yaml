extends: ../fused_data/sft_base.yaml

model:
  model: output/12-2/fusion_dlora_merged/checkpoint-4650

training:
  output_dir: ./output/12-4/res_1024_fusion
  logging_dir: ./tb/12-4/res_1024_fusion
  run_name: epoch_12-lrs_5_8_10
  num_train_epochs: 12
  warmup_ratio: 0.05
  learning_rate: 5.0e-5
  vit_lr: 8.0e-5
  aligner_lr: 1.0e-4
  save_delay_steps: 300


custom:
  fusion_config: configs/fusion/bbu_rru_lvis_coig_1024.yaml
  # More aggressive augmentation for high-res adaptation
  augmentation:
    enabled: true
    bypass_prob: 0.05
    ops:
      - name: hflip
        params: { prob: 0.22 }
      - name: vflip
        params: { prob: 0.06 }
      - name: rotate
        params: { max_deg: 18.0, prob: 0.30 }
      - name: expand_to_fit_affine
        params: { multiple: 32 }
      - name: random_crop
        params:
          scale: [0.82, 0.98]
          aspect_ratio: [0.90, 1.10]
          min_coverage: 0.35
          completeness_threshold: 0.95
          min_objects: 4
          skip_if_line: true
          prob: 0.18
      - name: small_object_zoom_paste
        params:
          prob: 0.18
          max_targets: 2
          max_attempts: 24
          scale: [1.5, 2.1]
          max_size: 96
          max_line_length: 128
          overlap_threshold: 0.1
          context: 4
          line_buffer: 4
      - name: resize_by_scale
        params: { lo: 0.90, hi: 1.12, align_multiple: 32, prob: 0.42 }
      - name: color_jitter
        params: { brightness: [0.90, 1.10], contrast: [0.90, 1.10], saturation: [0.90, 1.10], prob: 0.18 }
      - name: gamma
        params: { gamma: [0.90, 1.10], prob: 0.08 }
      - name: hsv
        params: { hue_delta_deg: [-5, 5], sat: [0.95, 1.05], val: [0.95, 1.05], prob: 0.08 }
      - name: clahe
        params: { clip_limit: 1.2, tile_grid_size: [8, 8], prob: 0.04 }
      - name: auto_contrast
        params: { cutoff: 0, prob: 0.04 }
      - name: sharpness
        params: { factor: [0.95, 1.08], prob: 0.05 }

  # Enable token/type grouping metrics for 1024 fusion targets.
  token_type_metrics:
    enabled: true
    include: [bbu, rru, lvis]
    exclude: [lang_chat]

  augmentation_curriculum:
    phases:
      - until_percent: 5
        bypass_prob: 0.80
        ops:
          hflip: { prob: 0.05 }
          rotate: { prob: 0.08, max_deg: 8.0 }
          resize_by_scale: { prob: 0.12, lo: 0.95, hi: 1.05 }
      - until_percent: 25
        bypass_prob: 0.25
        ops:
          rotate: { prob: 0.18, max_deg: 14.0 }
          random_crop: { prob: 0.12, scale: [0.88, 0.99], aspect_ratio: [0.92, 1.08], min_coverage: 0.4, completeness_threshold: 0.95 }
          resize_by_scale: { prob: 0.30, lo: 0.92, hi: 1.08 }
          color_jitter: { prob: 0.12, brightness: [0.94, 1.06], contrast: [0.94, 1.06], saturation: [0.94, 1.06] }
          small_object_zoom_paste: { prob: 0.12, scale: [1.4, 1.9], max_targets: 1, max_attempts: 18 }
      - until_percent: 100
        bypass_prob: 0.08
        ops: {}  # fall through to steady policy above
