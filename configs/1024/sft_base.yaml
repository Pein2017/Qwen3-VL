extends: ../fused_data/sft_base.yaml

model:
  model: model_cache/models/Qwen/Qwen3-VL-8B-Instruct

training:
  output_dir: ./output/12-9/res_1024_fusion
  logging_dir: ./tb/12-9/res_1024_fusion
  run_name: from_original-epoch_30-lrs_2-1-6-smoother_aug
  num_train_epochs: 30
  warmup_ratio: 0.1
  learning_rate: 2.0e-4
  vit_lr: 1.0e-4
  aligner_lr: 6.0e-4
  save_delay_steps: 800
  # logging_steps: 1
  # eval_steps: 1
  per_device_train_batch_size: 2
  per_device_eval_batch_size: 4
  effective_batch_size: 32

custom:
  fusion_config: configs/fusion/bbu_rru_lvis_coig_1024.yaml
  # More aggressive augmentation for high-res adaptation
  augmentation:
    enabled: true
    bypass_prob: 0.05
    ops:
      - name: hflip
        params: { prob: 0.22 }
      - name: vflip
        params: { prob: 0.06 }
      - name: rotate
        params: { max_deg: 18.0, prob: 0.30 }
      - name: expand_to_fit_affine
        params: { multiple: 32 }
      - name: random_crop
        params:
          scale: [0.82, 0.98]
          aspect_ratio: [0.90, 1.10]
          min_coverage: 0.35
          completeness_threshold: 0.95
          min_objects: 4
          skip_if_line: true
          prob: 0.18
      - name: small_object_zoom_paste
        params:
          prob: 0.18
          max_targets: 2
          max_attempts: 24
          scale: [1.5, 2.1]
          max_size: 96
          max_line_length: 128
          overlap_threshold: 0.1
          context: 4
          line_buffer: 4
          class_whitelist: ["螺丝、光纤插头", "光纤", "标签", "电线"]
      - name: resize_by_scale
        params: { lo: 0.90, hi: 1.12, align_multiple: 32, prob: 0.42 }
      - name: color_jitter
        params: { brightness: [0.90, 1.10], contrast: [0.90, 1.10], saturation: [0.90, 1.10], prob: 0.18 }
      - name: gamma
        params: { gamma: [0.90, 1.10], prob: 0.08 }
      - name: hsv
        params: { hue_delta_deg: [-5, 5], sat: [0.95, 1.05], val: [0.95, 1.05], prob: 0.08 }
      - name: clahe
        params: { clip_limit: 1.2, tile_grid_size: [8, 8], prob: 0.04 }
      - name: auto_contrast
        params: { cutoff: 0, prob: 0.04 }
      - name: sharpness
        params: { factor: [0.95, 1.08], prob: 0.05 }

  # Enable token/type grouping metrics for 1024 fusion targets.
  token_type_metrics:
    enabled: true
    include: [bbu, rru, lvis]
    exclude: [lang_chat]

