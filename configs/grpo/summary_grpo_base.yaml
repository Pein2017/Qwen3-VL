extends: ../fusion_train/sft_base.yaml

global_max_length: 16000

model:
  model: output/12-27/new_schema-4B-summary-merged/checkpoint-330

training:
  run_name: temperature_0.7-num_generations_4-vllm_colocate-eff_bs_24-gen_bs_24
  num_train_epochs: 2
  learning_rate: 1.0e-4
  vit_lr: 1.0e-7
  aligner_lr: 1.0e-7
  output_dir: ./output/12-30/new_schema-4B-summary-grpo
  logging_dir: ./tb/12-30/new_schema-4B-summary-grpo
  per_device_train_batch_size: 1
  per_device_eval_batch_size: 2
  effective_batch_size: 24
  metric_for_best_model: eval_reward
  logging_steps: 10
  logging_first_step: true
  # because step=1 is a single batch and later logs are windowed/averaged.
  logging_first_step: false
  eval_steps: 100
  # eval_strategy: 'no'
  warmup_ratio: 0.05
  save_delay_steps: 400
  
prompts:
  profile: summary_runtime
  domain: bbu


rlhf:
  rlhf_type: grpo
  reward_funcs: [summary_format, summary_header, summary_parse, summary_dataset, summary_objects_total, summary_content_f1]
  reward_weights: [1.0, 2.0, 1.5, 0.5, 0.5, 1.0]
  # Make core GRPO knobs explicit (avoid relying on library defaults).
  beta: 0.04
  kl_in_reward: false
  scale_rewards: group
  advantage_estimator: grpo
  num_generations: 4
  temperature: 0.7
  repetition_penalty: 1.05
  max_completion_length: 2048
  truncation_strategy: delete
  generation_batch_size: 24
  # ref model is not allowed for Lora training
  dynamic_sample: true
  max_resample_times: 1
  
  # vLLM Configuration - Colocate Mode (internal vLLM)
  use_vllm: true
  vllm_mode: colocate
  vllm_gpu_memory_utilization: 0.65
  vllm_enable_prefix_caching: true
  vllm_enable_lora: false
  # async_generate: true

custom:
  fusion_config: configs/dataset_mix/bbu_rru_summary_grpo_new_schema_1024.yaml
  use_summary: true
  val_sample_limit: 200
  assistant_prefix_format: "<DOMAIN={domain}>, <TASK={task}>"
  augmentation:
    enabled: true
    # Tiny, always-on augmentation (no curriculum).
    bypass_prob: 0.60
    ops:
      - name: resize_by_scale
        params: { lo: 0.98, hi: 1.02, align_multiple: 32, prob: 0.20 }
      - name: color_jitter
        params: { brightness: [0.95, 1.05], contrast: [0.95, 1.05], saturation: [0.95, 1.05], prob: 0.15 }
      - name: gamma
        params: { gamma: [0.97, 1.03], prob: 0.08 }
  augmentation_curriculum: null
