extends: ../fusion_train/sft_base.yaml

global_max_length: 16000

model:
  # model: output/12-27/new_schema-4B-summary-merged/checkpoint-330
  model: output/12-30/grpo-merged

training:
  run_name: continue_training-lrs_1e-5-more_rewards-epochs_2-chord_sft
  num_train_epochs: 2
  learning_rate: 1.0e-5
  vit_lr: 1.0e-7
  aligner_lr: 1.0e-7
  output_dir: ./output/1-1/new_schema-4B-summary-grpo
  logging_dir: ./tb/1-1/new_schema-4B-summary-grpo
  per_device_train_batch_size: 1
  per_device_eval_batch_size: 2
  effective_batch_size: 24
  metric_for_best_model: eval_reward
  logging_steps: 10
  logging_first_step: true
  # because step=1 is a single batch and later logs are windowed/averaged.
  logging_first_step: false
  eval_steps: 100
  # eval_strategy: 'no'
  warmup_ratio: 0.05
  save_delay_steps: 400

deepspeed:
  enabled: true
  # CHORD adds an extra forward graph per step. With ZeRO-2 this can trigger
  # "Gradient computed twice for this partition" assertions. Prefer ZeRO-3 for CHORD runs.
  config: zero3
  
prompts:
  profile: summary_runtime
  domain: bbu


rlhf:
  rlhf_type: grpo
  reward_funcs: [summary.format, summary.header, summary.strict, summary.parse, summary.no_dup_keys, summary.dataset, summary.objects_total_lb, summary.category_recall, summary.content_structured_tversky, summary.text_bbu, summary.notes_bbu, summary.group_stats_presence]
  reward_weights: [1.0, 2.0, 2.0, 1.5, 2.0, 0.5, 1.0, 0.5, 1.8, 0.8, 0.3, 0.2]
  # Make core GRPO knobs explicit (avoid relying on library defaults).
  beta: 0.04
  # Prefer ms-swift>=3.10 "AdvancedResearch" variants over vanilla GRPO:
  # - rloo: unbiased leave-one-out baseline (scale_rewards=none, kl_in_reward=true)
  # - reinforce_plus_plus: REINFORCE++ Baseline for outcome rewards (scale_rewards=batch, kl_in_reward=true)
  #
  # Current choice: REINFORCE++ Baseline.
  advantage_estimator: reinforce_plus_plus
  scale_rewards: batch
  kl_in_reward: true
  num_generations: 4
  temperature: 0.7
  repetition_penalty: 1.05
  max_completion_length: 2048
  truncation_strategy: delete
  generation_batch_size: 24
  # ref model is not allowed for Lora training
  dynamic_sample: true
  max_resample_times: 1
  
  # vLLM Configuration - Colocate Mode (internal vLLM)
  use_vllm: true
  vllm_mode: colocate
  vllm_gpu_memory_utilization: 0.55
  vllm_enable_prefix_caching: true
  vllm_enable_lora: false
  # async_generate: true

custom:
  fusion_config: configs/dataset_mix/bbu_rru_summary_grpo_new_schema_1024.yaml
  use_summary: true
  val_sample_limit: 200
  assistant_prefix_format: "<DOMAIN={domain}>, <TASK={task}>"
  # Optional: CHORD-style SFT mixing for GRPO (supervised fallback signal).
  # Uses the same (fusion) training dataset stream as expert data.
  grpo:
    chord:
      enabled: true
      # Keep SFT micro-batch minimal; tuned for GPUs that can only backprop one sample per device.
      sft_per_device_train_batch_size: 1
      # Conservative constant mu after warmup: ramps to 0.05 then stays.
      mu_warmup_steps: 100
      mu_decay_steps: 0
      mu_peak: 0.05
      mu_valley: 0.05
      enable_phi_function: false
  augmentation:
    enabled: true
    # Tiny, always-on augmentation (no curriculum).
    bypass_prob: 0.1
    ops:
      # Geometry: keep extremely mild to avoid changing semantics (no flips/crops).
      - name: rotate
        params: { max_deg: 2.0, prob: 0.12 }
      - name: resize_by_scale
        params: { lo: 0.98, hi: 1.02, align_multiple: 32, prob: 0.20 }
      # Image quality: mild distortions that preserve semantics but add realism.
      - name: auto_contrast
        params: { cutoff: 1, prob: 0.08 }
      - name: color_jitter
        params: { brightness: [0.95, 1.05], contrast: [0.95, 1.05], saturation: [0.95, 1.05], prob: 0.15 }
      - name: sharpness
        params: { factor: [0.9, 1.1], prob: 0.10 }
      - name: gamma
        params: { gamma: [0.97, 1.03], prob: 0.08 }
  augmentation_curriculum: null
