extends:
  - summary_1024.yaml

# Experimental preset: emphasize schema/field stability in summary outputs.
# Motivation: Stage-B relies on stable per-category attribute keys (e.g. 电线/捆扎),
# but Stage-A sometimes emits the category while omitting the attribute key.

model:
  model: output/1-21/grpo_summary_1024_attr_key_recall-v2-merged/ckpt_1600

training:
  # Avoid clobbering prior runs; edit per-run as needed.
  output_dir: ./output/1-21/grpo_summary_1024_attr_key_recall
  logging_dir: ./tb/1-21/grpo_summary_1024_attr_key_recall
  run_name: attr_key_recall-retry_v3
  num_train_epochs: 2
  logging_steps: 10
  eval_steps: 100
  warmup_ratio: 0.05
  save_delay_steps: 200
  per_device_train_batch_size: 1
  per_device_eval_batch_size: 2

rlhf:
  # Adds `summary.attr_key_recall` to explicitly reward emitting the same (类别, 属性名)
  # keys as the ground-truth summary_ref, independent of count calibration.
  # Also adds `summary.attr_path_recall` to reward emitting stable nested attribute paths
  # (e.g. 捆扎/整齐) for categories the model chooses to emit (scoring categories are
  # pred ∩ ref, so omitting a category is not directly penalized by this reward).
  # Adds `summary.schema_tree` to enforce per-category required keys (completeness)
  # and penalize emitting extra/unexpected attribute keys (schema drift).
  vllm_gpu_memory_utilization: 0.5
  reward_funcs:
    [
      summary.format,
      summary.header,
      summary.strict,
      summary.parse,
      summary.no_dup_keys,
      summary.dataset,
      summary.category_recall,
      summary.attr_key_recall,
      summary.attr_path_recall,
      summary.schema_tree,
      summary.content_structured_tversky,
      summary.group_stats_presence,
    ]
  # Suggested weights (recall-first):
  # - Keep format/header/strict strong to prevent schema drift.
  # - Add a dedicated key-recall reward to stabilize field emission.
  # - Add a nested attr-path recall reward to improve schema completeness for stable keys.
  # - Add a schema-tree reward to force "complete answers" per category and reduce
  #   long-tail/unstable attribute keys that confuse Stage-B.
  # - Slightly upweight structured tversky vs baseline preset.
  #
  # Notes on this preset:
  # - `summary.schema_tree` is intentionally strong: it enforces the attribute-key
  #   contract derived from the full corpus (bbu_full_1024 / rru_full_1024):
  #   required keys MUST appear; extra keys/categories/top-level keys are penalized.
  # - `summary.category_recall` prevents schema_tree from being gamed by omitting
  #   categories entirely.
  # - `summary.content_structured_tversky` preserves value-level correctness, but is
  #   kept below schema_tree to prioritize schema stability first.
  # Weights tuned based on rollout audit:
  # - Keep schema enforcement strong, but avoid over-penalizing benign key variants
  #   (especially for 光纤 protection keys after schema update).
  # - Slightly increase category_recall + attr_path_recall to improve per-category
  #   completeness without incentivizing key explosion.
  # - Increase header/strict modestly to reduce occasional <TASK=DETECTION> drift.
  #
  # Order MUST match rlhf.reward_funcs above.
  reward_weights: [1.5, 2.5, 3.5, 2.5, 3.0, 0.5, 2.0, 1.5, 1.5, 4.0, 3.0, 0.2]
