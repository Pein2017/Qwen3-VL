extends: ./sft_base.yaml

model:
  model: output/12-27/new_schema-4B-dense-merged/checkpoint-4470
  
global_max_length: 16000

prompts:
  profile: summary_runtime
  domain: bbu

tuner:
  # Summary tuning: keep vision/aligner stable and adapt the LLM for summary JSON formatting + OCR.
  freeze_vit: true
  freeze_aligner: true
  modules_to_save: []  # Keep lm_head fixed
  lora_rank: 8
  lora_alpha: 16

training:
  # Use a separate output directory from dense runs.
  output_dir: ./output/12-27/new_schema-4B-summary
  logging_dir: ./tb/12-27/new_schema-4B-summary
  run_name: epoch_2
  num_train_epochs: 2
  learning_rate: 1.0e-4
  vit_lr: 1.0e-7
  aligner_lr: 1.0e-7
  save_delay_steps: 300
  warmup_ratio: 0.05

custom:
  fusion_config: configs/dataset_mix/bbu_rru_summary_new_schema_2048.yaml
  use_summary: true
  assistant_prefix_format: "<DOMAIN={domain}>, <TASK={task}>"
  # Summary-mode labels are precomputed JSON strings in the JSONL.
  # Avoid any augmentation that can change which objects are visible
  # (e.g., random_crop / zoom-paste), otherwise the image no longer matches
  # the stored summary string.
  augmentation:
    enabled: true
    # Keep a high fraction of clean samples for OCR stability (站点距离 / 标签文本).
    bypass_prob: 0.40
    ops:
      # Mild multi-scale (no cropping): simulates different capture resolutions.
      - name: resize_by_scale
        params: { lo: 0.95, hi: 1.05, align_multiple: 32, prob: 0.25 }
      # Conservative photometric jitter for illumination/white-balance robustness.
      - name: color_jitter
        params: { brightness: [0.92, 1.08], contrast: [0.92, 1.08], saturation: [0.92, 1.08], prob: 0.25 }
      - name: gamma
        params: { gamma: [0.95, 1.05], prob: 0.12 }
      - name: hsv
        params: { hue_delta_deg: [-4, 4], sat: [0.95, 1.05], val: [0.95, 1.05], prob: 0.12 }
      - name: clahe
        params: { clip_limit: 1.5, tile_grid_size: [8, 8], prob: 0.05 }
      - name: auto_contrast
        params: { cutoff: 0, prob: 0.04 }
      - name: sharpness
        params: { factor: [0.95, 1.08], prob: 0.10 }

  # Disable inherited dense-mode curriculum (it references crop/patch ops).
  augmentation_curriculum: null
