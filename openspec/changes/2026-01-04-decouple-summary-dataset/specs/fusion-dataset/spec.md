# fusion-dataset Delta

## ADDED Requirements

### Requirement: Summary header derivation uses existing fusion metadata
For non-irrelevant summary samples, the assistant header SHALL be generated by deriving a domain token from existing metadata:
- If `_fusion_source == "irrelevant_summary"` → no header (even if `_fusion_template` is `summary_bbu`).
- Else if `_fusion_template == "summary_bbu"` → `<DOMAIN=BBU>`.
- Else if `_fusion_template == "summary_rru"` → `<DOMAIN=RRU>`.
Any summary sample that cannot resolve a domain token by these rules SHALL fail fast before prompt construction.

#### Scenario: Header derived from fusion template
- **GIVEN** a summary-mode sample with `_fusion_template = "summary_rru"`
- **WHEN** prompts are resolved
- **THEN** the assistant header uses `<DOMAIN=RRU>, <TASK=SUMMARY>`

#### Scenario: Irrelevant summary suppresses header
- **GIVEN** a summary-mode sample with `_fusion_source = "irrelevant_summary"`
- **WHEN** prompts are resolved
- **THEN** no header is emitted and the assistant output is single-line `无关图片`

#### Scenario: Unknown summary template fails fast
- **GIVEN** a summary-mode sample whose `_fusion_template` is not `summary_bbu` or `summary_rru`
- **WHEN** prompts are resolved
- **THEN** prompt construction fails with a clear error naming the template value

## MODIFIED Requirements

### Requirement: Domain provenance for fused records
The fusion loader SHALL tag every sample with `_fusion_domain`, `_fusion_source`, and `_fusion_template` so downstream telemetry and auditing can attribute padded batches to the correct domain.

#### Scenario: Provenance metadata available
- **WHEN** a sample is emitted by the fusion loader (online or offline fused JSONL)
- **THEN** its metadata contains `_fusion_domain`, `_fusion_source`, and `_fusion_template`
- **AND** these fields are preserved through preprocessing and encoding for downstream debugging, metric attribution, and padded batching
