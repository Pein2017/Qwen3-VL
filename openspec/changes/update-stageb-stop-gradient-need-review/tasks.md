# Tasks — update-stageb-stop-gradient-need-review

- [x] Update gradient-candidate detection to include:
  - label mismatches (`label_match=False`)
  - rollout contradictions (pass+fail mixed) / low-agreement
  - `conflict_flag=true` / `needs_manual_review=true` signals
- [x] Ensure reflection only ingests gradient candidates (exclude stable-correct/no-grad tickets from reflection context).
- [x] Implement two-pass reflection:
  - decision pass outputs `no_evidence_group_ids` (stop-gradient)
  - ops pass runs only on learnable groups (`G \\ S`) and emits strict JSON operations
- [x] Refine reflection prompt templates for two-pass:
  - add two separate prompt files (decision-pass + ops-pass)
  - ensure prompt states only `G0` is read-only; `G1+` are mutable
  - ops-pass prompt includes explicit evidence-coverage/closure instruction + hypothesis-exploration checklist (global/local, AND/OR, frequency/quantity)
  - ops-pass JSON supports optional `coverage` object (learnable/covered/uncovered group_ids) for observability
- [x] Add deterministic validator + router:
  - enforce `S ∩ E == ∅` (stop-gradient never appears in validated op evidence)
  - enforce learnability closure with bounded retries (uncovered `L \\ E` re-queued; default budget=2 retries per group per epoch; retries are reflection-only, no re-rollout)
  - enforce strict evidence validity (missing/empty/out-of-L evidence ⇒ reject op; no “missing evidence ⇒ default bundle” fallback)
  - enforce mission-level reflection cost caps and deterministic retry batch shrink policy
- [x] Enforce stop-gradient isolation:
  - stop-gradient tickets must not appear in ops pass inputs
  - stop-gradient tickets must not drive applied guidance updates
- [x] Add buffering for rule hit/miss feedback:
  - record pending feedback at selection time
  - commit only for learnable contributor tickets after reflection classification
  - drop feedback for stop-gradient + hard-fail tickets
- [x] Ensure need-review is non-sticky across epochs (re-evaluate each epoch; no blacklist).
- [x] Deprecate `manual_review_queue.jsonl` as a stop-gradient queue:
  - keep low-agreement/conflict/manual-review flags as learnable gradient triggers
  - surface uncertainty via exported signals instead of stopping gradients
- [x] Refine mission `initial_guidance` seeds to be learnability-friendly:
  - keep `G0` as mission definition / hard constraints
  - keep additional seed rules focused on evidence discipline and safe defaults
  - avoid hard-coding mission-specific latent thresholds that should be learned by reflection
- [x] Add targeted unit tests for:
  - contradiction-only tickets entering decision pass
  - two-pass isolation (stop-gradient never in ops pass evidence)
  - bounded retry behavior for uncovered learnable groups (default budget=2)
  - buffered feedback exclusion for stop-gradient tickets
- [x] Update runtime docs (`docs/runtime/STAGE_B_RUNTIME.md`, `docs/runtime/STAGE_A_STAGE_B.md`) to reflect:
  - need-review == stop-gradient
  - two-pass reflection
  - retry/buffering semantics
- [x] Validation:
  - `conda run -n ms pytest -q tests/stage_b`
  - `bash scripts/stage_b.sh smoke`
  - Optional: rerun a small mission config (e.g. `configs/stage_b/bbu_wind.yaml`) and inspect `need_review.json` + `reflection.jsonl` for invariant compliance.
