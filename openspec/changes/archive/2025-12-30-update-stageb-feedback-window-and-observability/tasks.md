# Tasks — update-stageb-feedback-window-and-observability

- [ ] 审阅现有 Stage‑B need-review/metrics/hit-miss 逻辑与工件（`src/stage_b/runner.py`, `src/stage_b/reflection/engine.py`, `src/stage_b/io/guidance.py`, `src/stage_b/scoring/selection.py`），明确字段与兼容性边界。
- [ ] need-review 路由调整（`src/stage_b/runner.py`）：
  - [ ] 将 “候选池任一候选支持 GT” 的门槛改为 “仅 winning candidate 支持 GT 才视为有支持”（以 `selection.label_match` 为准）。
  - [ ] 保持“硬故障不进 need-review”不变（硬故障仍只进 `failure_malformed.jsonl`）。
- [ ] need-review 汇总增强（`src/stage_b/runner.py` + `src/stage_b/io/group_report.py`）：
  - [ ] `need_review.json` 同时输出 `latest_by_ticket` 与 `all_history`，并保持确定性排序。
  - [ ] 保持对旧字段（如 `items`）的兼容或提供明确迁移说明（按最小破坏原则选择）。
- [ ] 新增 `reflection_malformed.jsonl`（`src/stage_b/reflection/engine.py` 或 runner 侧）：
  - [ ] 记录 JSON 解析/生成失败的最小可审计字段（mission、ticket_key、reflection_id（若有）、异常摘要、原始片段（可截断））。
  - [ ] 明确：reflection_malformed 不进入 need-review。
- [ ] 清理/规范化 “人工复核相关标记”：
  - [ ] 将 `in_manual_review` 的语义与原因桶拆清（need-review / failure_malformed / low_agreement / selection_manual_review 等）。
  - [ ] 更新 `metrics.jsonl` 使 include/exclude 口径可追溯到原因桶（并补充字段说明）。
- [ ] hit/miss 反馈降噪（`src/stage_b/runner.py` + `src/stage_b/io/guidance.py`）：
  - [ ] 引入 `feedback_window_steps=256`（基于 `global_step`）的归因窗口。
  - [ ] 仅对“困难票/冲突票”反馈（降噪版定义，减少实现难度）。
  - [ ] 以 `reflection_id` 聚合 credit，再回流到该次更新涉及的 keys。
  - [ ] hit/miss 在内存累积，每次 reflection flush 批量写回（必要时为 guidance repo 增加批量接口）。
- [ ] 规则生命周期（路线 B）（`src/stage_b/io/guidance.py`）：
  - [ ] 新增规则不自动 `hit_count +1`；仅 update/merge 既有规则才 +1。
- [ ] fail-first 例外护栏（`src/stage_b/scoring/selection.py` + config）：
  - [ ] 增加 `fail_first_exception_phrases`（子串匹配），并在日志/工件中记录“例外触发”的审计信息。
- [ ] 删除无用变量/残留痕迹（例如 `src/stage_b/runner.py` 的 `manual_review_path`）。
- [ ] 测试补齐（`tests/stage_b/`）：
  - [ ] need-review 只看 winning candidate 的路由行为。
  - [ ] `need_review.json` latest+all 的确定性与字段完整性。
  - [ ] `reflection_malformed.jsonl` 写入路径覆盖（解析失败不影响 need-review）。
  - [ ] “硬故障只进 failure_malformed，不进 need-review” 的最小回归用例。
- [ ] 文档更新（实现后执行）：
  - [ ] `docs/runtime/STAGE_A_STAGE_B.md`、`docs/runtime/STAGE_B_RUNTIME.md`
  - [ ] `docs/stage-B-knowledge-Chinese.md`
- [ ] 运行 `openspec validate update-stageb-feedback-window-and-observability --strict` 并修复所有格式问题。

