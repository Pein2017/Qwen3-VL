# Tasks — update-stageb-need-review-unification

- [x] 审阅现有 Stage‑B 队列与路由实现（`src/stage_b/runner.py`, `src/stage_b/reflection/engine.py`, `src/stage_b/io/group_report.py`），明确当前 `manual_review_queue.jsonl` / `need_review_queue.jsonl` 写入点与字段。
- [x] 更新 reflection prompt（`configs/prompts/stage_b_reflection_prompt.txt`）以支持“无监督式规则学习”：
  - [x] `gt=fail & pred=pass`：鼓励总结 fail 场景/关键证据缺失（允许假设规则）
  - [x] `gt=pass & pred=fail`：鼓励总结通过例外/跨任务负项不干扰本 mission
  - [x] 将 `has_evidence` 语义调整为“是否能提出可泛化、可验证、可淘汰的假设规则”（而非要求完美硬证据）
- [x] 移除/禁用 reflection 内部 “need‑review quarantine 阻断学习” 路径（保留必要的审计字段与日志），确保 need‑review 仅由“反思后仍不可学”触发。
- [x] 重写 runner 的队列路由策略（`src/stage_b/runner.py`）：
  - [x] 不再将 rollout/解析/选择硬故障写入人工复核队列；硬故障仅写入 `failure_malformed.jsonl`（或等价 debug 工件）并记录日志
  - [x] 基于“候选池无任何候选支持 `gt_label`（`label_match=True` 为 0）”的 ticket 级判定写入 `need_review_queue.jsonl`
  - [x] 不再因 `label_mismatch_after_reflection` 自动入队；错例优先进入学习闭环
- [x] 新增汇总导出：在 run 结束时生成 `need_review.json`（从 `need_review_queue.jsonl` 聚合），并保证聚合结果确定性（可复现）。
- [x] 补齐 rule hit/miss 闭环（`src/stage_b/io/guidance.py` + `src/stage_b/runner.py`）：
  - [x] 实现 `increment_hit_count(...)`（与 `increment_miss_count` 对称）
  - [x] 在 runner 中对 `last_applied_rule_keys` 进行后续 hit/miss 反馈（正确记 hit，错误记 miss）
  - [x] 验证 `cleanup_low_confidence(...)` 可在短周期内剔除低质量规则
- [x] 更新文档（至少）：
  - [x] `docs/runtime/STAGE_B_RUNTIME.md`（need‑review 新语义与工件）
  - [x] `docs/reference/stage-B-knowledge-Chinese.md`（业务侧复核入口调整）
- [x] 增加最小测试/回归检查（按现有测试框架选择合适位置）：
  - [x] “硬故障不进 need‑review”
  - [x] “候选池无任何候选支持 gt → 入 need‑review”
  - [x] `need_review.json` 聚合输出存在且字段齐全
- [x] 运行 `openspec validate update-stageb-need-review-unification --strict` 并修正所有格式问题。
