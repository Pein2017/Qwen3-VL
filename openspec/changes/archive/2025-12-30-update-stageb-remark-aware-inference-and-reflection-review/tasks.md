# Tasks — update-stageb-remark-aware-inference-and-reflection-review

- [x] 审阅现有 Stage‑B inference prompt（`src/stage_b/sampling/prompts.py`），移除 mission‑耦合名词示例列表，加入“需复核+备注”的软信号解释与“待确认信号”处理规则；并显式强调 **判定只以当前 mission 的 `G0` 为准**（同一组工单/图片可能被不同 mission 审核，不同 mission 下允许出现不同结论）。
- [x] 定义跨 mission 通用负项触发词表（仅动词/形容词/短语；必含：未按要求/错误/缺失/松动/损坏/方向不正确/反向/不符合要求/未安装/未配备/不合格/不合理），并实现 **mission‑scoped** group‑level fail‑first 护栏：仅当负项与当前 mission 的 `G0` 相关时才 fail‑first（建议在 `signals.py` + `selection.py` 或 runner 层）。
- [x] 负项通用化（pattern-first）：参考 `data_conversion/hierarchical_attribute_mapping.json` 与 `output_post/stage_b/initial_guidance.json` 的 canonical 表达，新增“结构化负项模式”检测（不靠穷举所有 issue）：
  - [x] `不符合要求/<issue>`：只要出现该模式即视为明确负项（`<issue>` 可能是未来 mission 新增描述，仍需 fail-first）
  - [x] `不合格` / `不合理` 等通用负向极性词面（与 mission 无关）也应被视为明确负项
- [x] 更新 inference prompt：在 system prompt 中加入一句“pattern-first + mission-scope”指引（例如：任何 `不符合要求/…` 形式均为明确负项，但仅对与当前 `G0` 相关的要点执行 fail‑first），以鼓励模型捕捉未来未见的负项描述，同时避免跨 mission 误伤。
- [x] 为 fail‑first 触发词检测加入最小“否定语境排除”以降低 FP（例如“无错误/未发现错误”等）。
- [x] 将“无法确认/无法判断/只显示部分/模糊”从硬触发否决改为待确认软信号；落地“无通过证据则不通过”的安全约束（prompt 为主，必要时添加轻量后验校验）。
- [x] 扩展 reflection/训练阶段的数据质量治理（`src/stage_b/reflection/engine.py`）：
  - [x] 引入 need‑review 队列工件（仅 `need_review_queue.jsonl`；不再使用 `label_or_stageA_noise.jsonl`）
  - [x] 强化证据一致性：label 与 Stage‑A summary 明显矛盾时不学习规则，仅入队 need‑review（用 tag 区分 `label_noise_suspect` / `stageA_noise_suspect` / `insufficient_evidence`）
  - [x] 保持 guidance 文本与 inference 输出协议均不出现第三状态措辞
- [x] 补充最小单元测试：
  - [x] 触发词检测（命中/否定排除/不含名词）
  - [x] mission‑scoped fail‑first：同一组摘要在不同 `G0` 下，相关负项触发 fail，不相关负项不应触发 fail（允许不同 mission 不同 verdict）
  - [x] 结构化负项模式：`不符合要求/<issue>` 对任意 `<issue>` 触发 fail-first（不要求穷举 issue）
  - [x] “需复核+备注”不会被硬等价为 fail（对比样例集）
  - [x] 输出协议严格两行二分类且无第三状态词面（含 guardrail 覆盖时 Reason 会被重写且与 Verdict 一致）
- [x] 更新文档：
  - [x] `docs/training/REFERENCE.md`
  - [x] `docs/runtime/STAGE_A_STAGE_B.md`
  - [x] `docs/reference/stage-B-knowledge-Chinese.md`
- [x] 运行 `openspec validate update-stageb-remark-aware-inference-and-reflection-review --strict` 并修正格式问题。
