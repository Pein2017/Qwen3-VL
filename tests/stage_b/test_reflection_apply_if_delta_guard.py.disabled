#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pathlib import Path
from dataclasses import dataclass

from src.stage_b.reflection.engine import ReflectionEngine
from src.stage_b.config import ReflectionConfig
from src.stage_b.io.guidance import GuidanceRepository
from src.stage_b.types import (
    ExperienceOperation,
    ReflectionAction,
    ReflectionOutcome,
    ReflectionProposal,
)


class _DummyModel:
    device = "cpu"


class _DummyTokenizer:
    pass


@dataclass(frozen=True)
class _DummyGuidanceRepo(GuidanceRepository):
    # Subclass to avoid filesystem writes during tests; override apply_reflection
    def __init__(self):
        # Use a temp path but avoid actual writes by overriding _write
        super().__init__(path=Path("/tmp/guidance_test.json"), retention=2)

    def apply_reflection(self, *args, **kwargs):  # noqa: D401
        # Return a minimal object compatible with engine expectations
        current = self.load().get("M", None)
        if current is None:
            self.ensure_initialized()
            guidance_path = tmp_path / "guidance.json"
            guidance_path.write_text(json.dumps({
                "M": {
                    "focus": "M任务要点",
                    "step": 1,
                    "updated_at": datetime.now(timezone.utc).isoformat(),
                    "experiences": {"G0": "初始经验"}
                }
            }, ensure_ascii=False, indent=2), encoding="utf-8")
            self.repo = GuidanceRepository(guidance_path, retention=1)
            current = self.get("M")
        return current


_TEMPLATE = (
    "任务: {mission}\n重点: {focus}\n经验:\n{experiences}\n捆绑:\n{bundle}\n\n"
    "请严格输出JSON，允许的操作: upsert|remove|merge。"
)


def _mk_engine(tmpdir: Path, apply_if_delta=None) -> ReflectionEngine:
    prompt = tmpdir / "refl_prompt.txt"
    prompt.write_text(_TEMPLATE, encoding="utf-8")
    cfg = ReflectionConfig(
        prompt_path=prompt,
        batch_size=1,
        apply_if_delta=apply_if_delta,
        allow_uncertain=True,
        rapid_mode=False,
        eligibility_policy="selected_mismatch_or_all_wrong",
        max_operations=None,
        change_cap_per_epoch=None,
        temperature=1.0,
        top_p=0.95,
        max_new_tokens=32,
        max_reflection_length=512,
    )
    repo = _DummyGuidanceRepo()
    return ReflectionEngine(_DummyModel(), _DummyTokenizer(), cfg, repo, reflection_log=tmpdir / "log.jsonl")


def test_finalize_outcome_guard_none(tmp_path: Path):
    eng = _mk_engine(tmp_path, apply_if_delta=None)
    outcome = ReflectionOutcome(
        reflection_id="r",
        mission="M",
        proposal=ReflectionProposal(
            action=ReflectionAction("refine"),
            summary=None,
            critique=None,
            operations=(ExperienceOperation(op="upsert", key="G0", text="x", rationale=None),),
            evidence_group_ids=("g",),
        ),
        applied=False,
        pre_uplift=0.2,
        post_uplift=0.1,
        guidance_step_before=1,
        guidance_step_after=1,
        operations=(ExperienceOperation(op="upsert", key="G0", text="x", rationale=None),),
        eligible=True,
    )
    # Should not crash when apply_if_delta is None
    _ = eng.finalize_outcome(outcome, epoch=0, pre_uplift=0.2, post_uplift=0.1)


def test_finalize_outcome_guard_threshold(tmp_path: Path):
    eng = _mk_engine(tmp_path, apply_if_delta=0.05)
    outcome = ReflectionOutcome(
        reflection_id="r2",
        mission="M",
        proposal=ReflectionProposal(
            action=ReflectionAction("refine"),
            summary=None,
            critique=None,
            operations=(ExperienceOperation(op="upsert", key="G0", text="x", rationale=None),),
            evidence_group_ids=("g",),
        ),
        applied=False,
        pre_uplift=0.2,
        post_uplift=0.1,
        guidance_step_before=1,
        guidance_step_after=1,
        operations=(ExperienceOperation(op="upsert", key="G0", text="x", rationale=None),),
        eligible=True,
    )
    # Should gate when delta < threshold (no exception expected)
    _ = eng.finalize_outcome(outcome, epoch=0, pre_uplift=0.2, post_uplift=0.1)

